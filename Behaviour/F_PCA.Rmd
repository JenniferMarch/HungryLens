---
title: "PCA"
author: "Jennifer March (jennifer.march@uni-hamburg.de"
date: "2024-09-13"
output: html_document
---

### Information
This script executes PCA and respective plots

### 1 Preparation
#### 1.1 Load Data
```{r}
#clear working environment
rm(list=ls())

#clear all plots
if(!is.null(dev.list())) dev.off()

load("food_data.RData")
```

```{r}
data_combined_neu$choice_nutri<-999
for (i in 1:nrow(data_combined_neu)){
  if(((data_combined_neu$response[i]=='left') && (data_combined_neu$taste_left[i]>=data_combined_neu$taste_right[i]) && (data_combined_neu$nutri_left2[i]<=data_combined_neu$nutri_right2[i])) || ((data_combined_neu$response[i]=='right') && (data_combined_neu$taste_left[i]<=data_combined_neu$taste_right[i]) && (data_combined_neu$nutri_left2[i]>=data_combined_neu$nutri_right2[i]))) { #left want or right want
    data_combined_neu$choice_nutri[i]<-1
  }else if (((data_combined_neu$response[i]=='left') && (data_combined_neu$taste_left[i]<data_combined_neu$taste_right[i]) && (data_combined_neu$nutri_left2[i]>data_combined_neu$nutri_right2[i])) || ((data_combined_neu$response[i]=='right') && (data_combined_neu$taste_left[i]>data_combined_neu$taste_right[i]) && (data_combined_neu$nutri_left2[i]<data_combined_neu$nutri_right2[i]))) {
    data_combined_neu$choice_nutri[i]<-0
  }
}


# exclude neutrals (999s)
data_combined_nutri<-subset(data_combined_neu, choice_nutri != 999)
library("dplyr")
## check how much trials --> also more trials on average and smaller SD
trialn<- data_combined_nutri %>%
  group_by(subject, condition)%>%
  summarise(trialnr=length(trial))

mean(trialn$trialnr)
sd(trialn$trialnr)

```


#### 1.2 Create Theme
```{r}
library(ggplot2)
myTheme <- theme(
  axis.line = element_line(colour = "black"), 
  panel.grid.major = element_blank(), 
  panel.grid.minor = element_blank(),  
  panel.border = element_blank(),   
  panel.background = element_blank(),
  text=element_text(size=16, colour = "black"), 
  axis.title.x = element_text(size=20, face="bold", colour = "black"), 
  axis.title.y = element_text( size=20, face="bold", colour = "black"),
  axis.text = element_text(size=16),
  strip.text =  element_text( size=16),
  strip.background = element_rect(fill = "white", colour = "black"),
  legend.background = element_rect(colour = "black"),
  legend.key = element_blank(),
  legend.key.size = unit(3, "lines"))
```

### 2 Correlations
Are there correlations between the predictors?
```{r}

data_combined_neu2 <- subset(data_combined_neu,rel_dwelldiff_chosen!='NaN')

data_combined_neu2$taste_vd2<-data_combined_neu2$taste_left-data_combined_neu2$taste_right
data_combined_neu2$health_vd2<-data_combined_neu2$health_left-data_combined_neu2$health_right
data_combined_neu2$nutri_diff2<-data_combined_neu2$nutri_left2-data_combined_neu2$nutri_right2
data_combined_neu2$pref_vd2<-data_combined_neu2$pref_left-data_combined_neu2$pref_right
data_combined_neu2$cal_vd2<-data_combined_neu2$cal_left-data_combined_neu2$cal_right
data_combined_neu2$total_cal_vd2<-data_combined_neu2$kcal_left-data_combined_neu2$kcal_right


predictor_data3 <- data_combined_neu2[, c("nutri_diff2", "pref_vd2", "health_vd2", "taste_vd2", "cal_vd2", "total_cal_vd2")]
correlation_matrix3 <- cor(predictor_data3, use="complete.obs")


png("Predictor_corrplot.png", width = 600, height = 600)  # Save it as a PNG file; adjust dimensions as needed

corrplot::corrplot(correlation_matrix3, 
                   method = "color", 
                   addCoef.col = "black", 
                   tl.cex = 1.5, 
                   tl.col = "black",
                   number.cex = 1.5, 
                   col = colorRampPalette(c("cornflowerblue", "white", "red3"))(200), 
                   order = "hclust", 
                   diag = FALSE)
dev.off()
```


### 3 PCA
**Problem:** Given the high Multi-Collinearity among predictors, find out which variables are the most important ones to be used in Modeling. 
**Approach:** PCA for most important food characteristics
**Result:** The first two components explain about 80% of variance. 
```{r}
# Load necessary libraries
library(FactoMineR)  # For PCA
library(factoextra)  # For visualizing PCA

# Standardize
standardized_data3 <- scale(data_combined_neu2[, c("health_vd2", "taste_vd2", "nutri_diff2", "pref_vd2", "cal_vd2", "total_cal_vd2")])

# Perform PCA
pca_result3 <- PCA(standardized_data3, graph = FALSE)  # graph = FALSE to suppress automatic plotting

#show looadings
pca_result3$var$coord

#add PCs to data for GLMM
data_combined_neu2$nutrition_score<-pca_result3$ind$coord[,1]
data_combined_neu2$liking_score<-pca_result3$ind$coord[,2]

```
**Screeplot**
```{r}
scree_plot<-fviz_eig(pca_result3, 
        addlabels = TRUE, 
        hjust = 0,
        barcolor = "black",   
        barfill = "grey",
        ylim = c(0,65),
        xlab = "Principal Components",  
        ylab = "Eigenvalues",
        ggtheme = myTheme, 
        main = NULL)+ theme(plot.title = element_blank())

scree_plot
ggsave("screeplot2.png", scree_plot, width = 5, height = 7)

```